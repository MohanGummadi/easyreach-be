<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Create Receipt</title>
</head>
<body class="container py-4">
<h2 class="mb-3">Create Receipt</h2>
<form th:action="@{/receipts}" method="post" enctype="multipart/form-data">
    <div class="mb-3">
        <label class="form-label">Order ID</label>
        <div class="input-group">
            <input class="form-control" type="text" name="orderId" required>
            <button class="btn btn-secondary" type="button" id="searchBtn">Search</button>
        </div>
        <div id="searchMessage" class="form-text text-danger"></div>
    </div>
    <div class="mb-3">
        <label class="form-label">Trip No</label>
        <input class="form-control" type="text" name="tripNo">
    </div>
    <div class="mb-3">
        <label class="form-label">Customer Name</label>
        <input class="form-control" type="text" name="customerName">
    </div>
    <div class="mb-3">
        <label class="form-label">Customer Mobile</label>
        <input class="form-control" type="text" name="customerMobile">
    </div>
    <div class="mb-3">
        <label class="form-label">Sand Quantity</label>
        <select class="form-select" name="sandQuantity">
            <option value="10">10</option>
            <option value="20">20</option>
            <option value="25">25</option>
            <option value="30">30</option>
            <option value="35">35</option>
        </select>
    </div>
    <div class="mb-3">
        <label class="form-label">Dispatch Date/Time</label>
        <input class="form-control" type="datetime-local" name="dispatchDateTime">
    </div>
    <div class="mb-3">
        <label class="form-label">Driver Name</label>
        <input class="form-control" type="text" name="driverName">
    </div>
    <div class="mb-3">
        <label class="form-label">Driver Mobile</label>
        <input class="form-control" type="text" name="driverMobile">
    </div>
    <div class="mb-3">
        <label class="form-label">Vehicle No</label>
        <input class="form-control" type="text" name="vehicleNo">
    </div>
    <div class="mb-3">
        <label class="form-label">Address</label>
        <textarea class="form-control" name="address"></textarea>
    </div>
    <div class="mb-3">
        <label class="form-label">QR Image</label>
        <input class="form-control" type="file" name="qrPng" accept="image/png">
    </div>
    <div class="mb-3">
        <label class="form-label">QR URL</label>
        <input class="form-control" type="text" name="qrUrl">
    </div>
    <button class="btn btn-primary" type="submit">Generate PDF</button>
</form>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const orderInput = document.querySelector('input[name="orderId"]');
    const searchBtn = document.getElementById('searchBtn');
    const messageEl = document.getElementById('searchMessage');
    if (!orderInput || !searchBtn) return;

    const makeUpper = () => {
        orderInput.value = orderInput.value.toUpperCase();
    };
    orderInput.addEventListener('input', makeUpper);
    orderInput.addEventListener('blur', makeUpper);

    searchBtn.addEventListener('click', async () => {
        const orderId = orderInput.value;
        if (!orderId) {
            return;
        }
        messageEl.textContent = '';
        try {
            const res = await fetch(`/api/receipts/order/${orderId}`);
            if (res.status === 404) {
                messageEl.textContent = 'No order id found';
                return;
            }
            if (!res.ok) {
                messageEl.textContent = 'Failed to search';
                return;
            }
            const data = await res.json();
            const mapping = {
                tripNo: 'input[name="tripNo"]',
                customerName: 'input[name="customerName"]',
                customerMobile: 'input[name="customerMobile"]',
                sandQuantity: 'select[name="sandQuantity"]',
                dispatchDateTime: 'input[name="dispatchDateTime"]',
                address: 'textarea[name="address"]',
                qrUrl: 'input[name="qrUrl"]'
            };
            for (const [key, selector] of Object.entries(mapping)) {
                if (data[key] != null) {
                    const el = document.querySelector(selector);
                    if (el) {
                        el.value = data[key];
                    }
                }
            }
        } catch (e) {
            console.error('Failed to fetch receipt by order ID', e);
            messageEl.textContent = 'Failed to search';
        }
    });
});
</script>
</body>
</html>

